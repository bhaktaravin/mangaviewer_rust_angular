<div class="manga-detail-container">
  <!-- Debug info -->
  <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
    <strong>Debug:</strong> Manga data: {{ manga() | json }}
  </div>

  <!-- Manga Info Header -->
  <div class="manga-header" *ngIf="manga()">
    <div class="manga-cover">
      @if (manga().cover_image || manga().thumbnail) {
        <img 
          [src]="manga().cover_image || manga().thumbnail" 
          [alt]="manga().title || manga().name"
          onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'"
        />
      } @else {
        <div class="placeholder-cover">
          <span class="placeholder-text">üìö</span>
        </div>
      }
    </div>
    
    <div class="manga-info">
      <h1 class="manga-title">{{ manga().title || manga().name || 'Unknown Title' }}</h1>
      
      @if (manga().author || manga().authors) {
        <p class="manga-author">
          <strong>Author:</strong> {{ manga().author || manga().authors }}
        </p>
      }
      
      @if (manga().status) {
        <p class="manga-status">
          <strong>Status:</strong> 
          <span class="status-badge" [class]="manga().status">
            {{ manga().status | titlecase }}
          </span>
        </p>
      }
      
      @if (manga().description) {
        <p class="manga-description">{{ manga().description }}</p>
      }
      
      @if (manga().genre || manga().genres || manga().tags) {
        <div class="manga-tags">
          <strong>Tags:</strong>
          <div class="tags-list">
            @for (tag of (manga().tags || manga().genre?.split(',') || manga().genres?.split(',') || []); track $index) {
              <span class="tag">{{ tag.trim() }}</span>
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- No manga data message -->
  <div *ngIf="!manga()" class="no-manga-message" style="text-align: center; padding: 20px;">
    <p>No manga data available</p>
  </div>

  <!-- Chapters Section -->
  <div class="chapters-section" *ngIf="manga()">
    <div class="section-header">
      <div class="header-content">
        <h2>üìñ Chapters</h2>
        @if (chapters().length > 0) {
          <span class="chapter-count">{{ chapters().length }} chapters available</span>
        }
      </div>
      
      @if (isAuthenticated() && chapters().length > 0) {
        <div class="bulk-actions">
          <button 
            class="btn btn-primary btn-bulk-download"
            (click)="openBulkDownloadModal()"
            [disabled]="bulkDownloading()"
          >
            @if (bulkDownloading()) {
              <span class="spinner"></span>
              Downloading...
            } @else {
              üì¶ Download All Chapters
            }
          </button>
        </div>
      }
    </div>

    @if (loading()) {
      <div class="loading-state">
        <span class="spinner"></span>
        Loading chapters...
      </div>
    }

    @if (error() && !loading()) {
      <div class="error-message">
        <span class="error-icon">‚ö†Ô∏è</span>
        {{ error() }}
        <button class="btn btn-small" (click)="loadChapters()">Retry</button>
      </div>
    }

    @if (chapters().length > 0) {
      <div class="chapters-list">
        @for (chapter of chapters(); track chapter.id) {
          <div class="chapter-item">
            <div class="chapter-info">
              <h4 class="chapter-title">{{ getChapterTitle(chapter) }}</h4>
              <div class="chapter-meta">
                @if (chapter.attributes.volume) {
                  <span class="volume">Vol. {{ chapter.attributes.volume }}</span>
                }
                <span class="pages">{{ chapter.attributes.pages }} pages</span>
                <span class="language">{{ chapter.attributes.translatedLanguage.toUpperCase() }}</span>
                <span class="date">{{ chapter.attributes.publishAt | date:'shortDate' }}</span>
              </div>
            </div>
            
            <div class="chapter-actions">
              <button class="btn btn-outline btn-small">
                üìñ Read Online
              </button>
              <button 
                class="btn btn-primary btn-small"
                (click)="openDownloadModal(chapter)"
              >
                üíæ Download
              </button>
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Download Modal -->
  @if (showDownloadModal()) {
    <div class="modal-overlay" (click)="closeDownloadModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üíæ Download Chapter</h3>
          <button class="modal-close" (click)="closeDownloadModal()">√ó</button>
        </div>
        
        <div class="modal-body">
          @if (selectedChapter()) {
            <div class="download-info">
              <h4>{{ getChapterTitle(selectedChapter()!) }}</h4>
              <p>{{ selectedChapter()!.attributes.pages }} pages</p>
            </div>
          }
          
          <div class="download-settings">
            <div class="setting-group">
              <label for="quickPaths">Quick Path Selection:</label>
              <select
                id="quickPaths"
                [ngModel]="selectedCommonPath()"
                (ngModelChange)="onCommonPathChange($event)"
                class="setting-select"
              >
                @for (pathOption of commonPaths; track pathOption.path) {
                  <option [value]="pathOption.path">{{ pathOption.label }}</option>
                }
              </select>
              <small class="setting-help">Choose from common download locations</small>
            </div>

            <div class="setting-group">
              <label for="savePath">Save Location:</label>
              <div class="path-input-group">
                <input
                  id="savePath"
                  type="text"
                  [ngModel]="downloadSettings().savePath"
                  (ngModelChange)="updateDownloadSetting('savePath', $event)"
                  placeholder="/path/to/download/folder"
                  class="setting-input path-input"
                  [class.invalid]="!isValidPath(downloadSettings().savePath)"
                />
                <button
                  type="button"
                  class="btn btn-outline btn-small browse-btn"
                  (click)="openDirectoryPicker()"
                  title="Browse for folder"
                >
                  üìÅ Browse
                </button>
                <button
                  type="button"
                  class="btn btn-outline btn-small"
                  (click)="promptForCustomPath()"
                  title="Enter custom path"
                >
                  ‚úèÔ∏è Custom
                </button>
              </div>
              <small class="setting-help">
                @if (!isValidPath(downloadSettings().savePath)) {
                  <span class="error-text">‚ö†Ô∏è Please enter a valid download path</span>
                } @else {
                  <div class="path-preview">
                    <strong>üìÅ Files will be saved to:</strong><br>
                    <code class="save-path-display">{{ downloadSettings().savePath }}/{{ downloadSettings().mangaTitle }}/{{ getChapterTitle(selectedChapter()!) }}</code>
                  </div>
                }
              </small>
            </div>
            
            <div class="setting-group">
              <label for="mangaTitle">Manga Title:</label>
              <input
                id="mangaTitle"
                type="text"
                [ngModel]="downloadSettings().mangaTitle"
                (ngModelChange)="updateDownloadSetting('mangaTitle', $event)"
                class="setting-input"
              />
              <small class="setting-help">Used for folder organization</small>
            </div>
            
            <div class="setting-group">
              <label for="quality">Quality:</label>
              <select
                id="quality"
                [ngModel]="downloadSettings().quality"
                (ngModelChange)="updateDownloadSetting('quality', $event)"
                class="setting-select"
              >
                <option value="high">High Quality {{ formatFileSize('high') }}</option>
                <option value="saver">Data Saver {{ formatFileSize('saver') }}</option>
              </select>
              <small class="setting-help">High quality uses more storage but better image quality</small>
            </div>
          </div>
          
          @if (downloadProgress()) {
            <div class="download-result">
              <div class="success-message">
                <span class="success-icon">‚úÖ</span>
                <strong>{{ downloadProgress().message }}</strong>
              </div>
              
              <div class="download-details">
                <p><strong>Saved to:</strong> {{ downloadProgress().save_path }}</p>
                <p><strong>Files downloaded:</strong> {{ downloadProgress().successful_downloads }}/{{ downloadProgress().total_pages }}</p>
                
                @if (downloadProgress().failed_downloads.length > 0) {
                  <div class="failed-downloads">
                    <p><strong>Failed downloads:</strong></p>
                    <ul>
                      @for (failure of downloadProgress().failed_downloads; track $index) {
                        <li>{{ failure }}</li>
                      }
                    </ul>
                  </div>
                }
              </div>
            </div>
          }
          
          @if (error()) {
            <div class="error-message">
              <span class="error-icon">‚ö†Ô∏è</span>
              {{ error() }}
            </div>
          }
        </div>
        
        <div class="modal-footer">
          <button 
            class="btn btn-secondary" 
            (click)="closeDownloadModal()"
            [disabled]="downloading()"
          >
            Cancel
          </button>
          <button 
            class="btn btn-primary"
            (click)="downloadChapter()"
            [disabled]="downloading() || !isValidPath(downloadSettings().savePath)"
          >
            @if (downloading()) {
              <span class="spinner"></span>
              Downloading...
            } @else {
              üíæ Download Chapter
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Bulk Download Modal -->
  @if (showBulkDownloadModal()) {
    <div class="modal-overlay" (click)="closeBulkDownloadModal()">
      <div class="modal-content bulk-download-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üì¶ Download All Chapters</h3>
          <button class="modal-close" (click)="closeBulkDownloadModal()" [disabled]="bulkDownloading()">√ó</button>
        </div>
        
        <div class="modal-body">
          @if (!bulkDownloading() && !bulkDownloadProgress()) {
            <div class="bulk-download-info">
              <p>This will download all <strong>{{ chapters().length }}</strong> chapters of <strong>{{ manga().title }}</strong>.</p>
              
              <div class="download-settings-summary">
                <div class="setting-item">
                  <strong>üìÅ Save Path:</strong> {{ downloadSettings().savePath }}
                </div>
                <div class="setting-item">
                  <strong>üé® Quality:</strong> {{ formatFileSize(downloadSettings().quality) }}
                </div>
                <div class="setting-item">
                  <strong>‚ö†Ô∏è Authentication:</strong> 
                  @if (isAuthenticated()) {
                    <span class="auth-status authenticated">‚úÖ Authenticated</span>
                  } @else {
                    <span class="auth-status not-authenticated">‚ùå Not Authenticated</span>
                  }
                </div>
              </div>

              <div class="bulk-warning">
                <p><strong>‚ö†Ô∏è Please note:</strong></p>
                <ul>
                  <li>This may take several minutes depending on the number of chapters</li>
                  <li>Ensure you have sufficient disk space</li>
                  <li>Do not close this window during the download process</li>
                </ul>
              </div>
            </div>
          }

          @if (bulkDownloading() || bulkDownloadProgress()) {
            <div class="bulk-progress">
              @if (bulkDownloading()) {
                <div class="progress-header">
                  <h4>Downloading chapters... {{ getBulkDownloadProgress() }}</h4>
                  <div class="progress-bar">
                    <div 
                      class="progress-fill" 
                      [style.width.%]="bulkDownloadProgress() ? (bulkDownloadProgress()!.current / bulkDownloadProgress()!.total) * 100 : 0"
                    ></div>
                  </div>
                </div>

                @if (bulkDownloadProgress()) {
                  <div class="current-chapter">
                    <p><strong>Currently downloading:</strong> {{ bulkDownloadProgress()!.currentChapter }}</p>
                  </div>

                  <div class="progress-stats">
                    <div class="stat completed">
                      <span class="stat-icon">‚úÖ</span>
                      <span>Completed: {{ bulkDownloadProgress()!.completed.length }}</span>
                    </div>
                    @if (bulkDownloadProgress()!.failed.length > 0) {
                      <div class="stat failed">
                        <span class="stat-icon">‚ùå</span>
                        <span>Failed: {{ bulkDownloadProgress()!.failed.length }}</span>
                      </div>
                    }
                  </div>
                }
              }

              @if (!bulkDownloading() && bulkDownloadProgress()) {
                <div class="download-complete">
                  <h4>{{ getBulkDownloadSummary() }}</h4>
                  
                  @if (bulkDownloadProgress()!.failed.length > 0) {
                    <div class="failed-chapters">
                      <p><strong>Failed chapters:</strong></p>
                      <ul>
                        @for (failedId of bulkDownloadProgress()!.failed; track failedId) {
                          <li>{{ failedId }}</li>
                        }
                      </ul>
                    </div>
                  }
                </div>
              }
            </div>
          }

          @if (error()) {
            <div class="error-message">
              <span class="error-icon">‚ö†Ô∏è</span>
              {{ error() }}
            </div>
          }
        </div>
        
        <div class="modal-footer">
          @if (!bulkDownloading()) {
            <button 
              class="btn btn-secondary" 
              (click)="closeBulkDownloadModal()"
            >
              @if (bulkDownloadProgress()) {
                Close
              } @else {
                Cancel
              }
            </button>
            
            @if (!bulkDownloadProgress() && isAuthenticated()) {
              <button 
                class="btn btn-primary" 
                (click)="downloadAllChapters()"
                [disabled]="!isValidPath(downloadSettings().savePath)"
              >
                üöÄ Start Bulk Download
              </button>
            }
          }
        </div>
      </div>
    </div>
  }
</div>
