<div class="manga-detail-container">
  <!-- Manga Info Header -->
  <div class="manga-header">
    <div class="manga-cover">
      <!-- No cover_image/thumbnail in Manga, so fallback to placeholder always -->
      <div class="placeholder-cover">
        <span class="placeholder-text">üìö</span>
      </div>
    </div>
    
    <div class="manga-info">
      <h1 class="manga-title">{{ manga?.attributes?.title?.['en'] || manga?.attributes?.title?.['jp'] || 'Unknown Title' }}</h1>
      
      <!-- Author is in relationships, not a direct property. Omit for now or show 'Unknown' -->
      <p class="manga-author"><strong>Author:</strong> Unknown</p>
      <ng-container *ngIf="manga?.attributes?.status">
        <p class="manga-status">
          <strong>Status:</strong>
          <span class="status-badge" [class]="manga?.attributes?.status">
            {{ manga?.attributes?.status | titlecase }}
          </span>
        </p>
      </ng-container>
      <ng-container *ngIf="manga?.attributes?.description?.['en']">
        <p class="manga-description">{{ manga?.attributes?.description?.['en'] || '' }}</p>
      </ng-container>
      <!-- Tags/genres omitted: not present in Manga interface -->
      <span class="chapter-count">{{ chapters.length }} chapters available</span>
    </div>

    @if (loading) {
      <div class="loading-state">
        <span class="spinner"></span>
        Loading chapters...
      </div>
    }

    @if (error && !loading) {
      <div class="error-message">
        <span class="error-icon">‚ö†Ô∏è</span>
        {{ error }}
        <button class="btn btn-small" (click)="loadChapters()">Retry</button>
      </div>
    }

    @if (chapters.length > 0) {
      <div class="chapters-list">
        @for (chapter of chapters; track chapter.id) {
          <div class="chapter-item">
            <div class="chapter-info">
              <h4 class="chapter-title">{{ getChapterTitle(chapter) }}</h4>
              <div class="chapter-meta">
                @if (chapter.attributes.volume) {
                  <span class="volume">Vol. {{ chapter.attributes.volume }}</span>
                }
                <span class="pages">{{ chapter.attributes.pages }} pages</span>
                <span class="language">{{ chapter.attributes.translatedLanguage.toUpperCase() }}</span>
                <span class="date">{{ chapter.attributes.publishAt | date:'shortDate' }}</span>
              </div>
            </div>
            
            <div class="chapter-actions">
              <button class="btn btn-outline btn-small">
                üìñ Read Online
              </button>
              <button 
                class="btn btn-primary btn-small"
                (click)="openDownloadModal(chapter)"
              >
                üíæ Download
              </button>
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Download Modal -->
  @if (showDownloadModal) {
    <div class="modal-overlay" (click)="closeDownloadModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üíæ Download Chapter</h3>
          <button class="modal-close" (click)="closeDownloadModal()">√ó</button>
        </div>
        <div class="modal-body">
          @if (selectedChapter) {
            <div class="download-info">
              <h4>{{ getChapterTitle(selectedChapter) }}</h4>
              <p>{{ selectedChapter.attributes.pages }} pages</p>
            </div>
          }
          <div class="download-settings">
            <div class="setting-group">
              <label for="quickPaths">Quick Path Selection:</label>
              <select
                id="quickPaths"
                [ngModel]="selectedCommonPath"
                (ngModelChange)="onCommonPathChange($event)"
                class="setting-select"
              >
                @for (pathOption of commonPaths; track pathOption.path) {
                  <option [value]="pathOption.path">{{ pathOption.label }}</option>
                }
              </select>
              <small class="setting-help">Choose from common download locations</small>
            </div>
            <div class="setting-group">
              <label for="mangaTitle">Manga Title:</label>
              <input
                id="mangaTitle"
                type="text"
                [ngModel]="downloadSettings.mangaTitle"
                (ngModelChange)="updateDownloadSetting('mangaTitle', $event)"
                class="setting-input"
              />
              <small class="setting-help">Used for folder organization</small>
            </div>
            <div class="setting-group">
              <label for="quality">Quality:</label>
              <select
                id="quality"
                [ngModel]="downloadSettings.quality"
                (ngModelChange)="updateDownloadSetting('quality', $event)"
                class="setting-select"
              >
                <option value="high">High Quality {{ formatFileSize('high') }}</option>
                <option value="saver">Data Saver {{ formatFileSize('saver') }}</option>
              </select>
              <small class="setting-help">High quality uses more storage but better image quality</small>
            </div>
          </div>
          @if (downloadProgress) {
            <div class="download-result">
              <div class="success-message">
                <span class="success-icon">‚úÖ</span>
                <strong>Download complete</strong>
              </div>
              <div class="download-details">
                <p><strong>Status:</strong> {{ downloadProgress.status }}</p>
                <p><strong>Progress:</strong> {{ downloadProgress.progress }}%</p>
              </div>
            </div>
          }
          @if (error) {
            <div class="error-message">
              <span class="error-icon">‚ö†Ô∏è</span>
              {{ error }}
            </div>
          }
        </div>
        <div class="modal-footer">
          <button 
            class="btn btn-secondary" 
            (click)="closeDownloadModal()"
            [disabled]="downloading"
          >
            Cancel
          </button>
          <button 
            class="btn btn-primary"
            (click)="downloadChapter()"
            [disabled]="downloading || !isValidPath(downloadSettings.savePath)"
          >
            @if (downloading) {
              <span class="spinner"></span>
              Downloading...
            } @else {
              üíæ Download Chapter
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
